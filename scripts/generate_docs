import os
import sys

r_path = os.environ["REPO_PATH"]

from git import Repo
from github import Github, InputGitAuthor
import subprocess


def switch_branch():
    repo = Repo(r_path)

    for head in repo.heads:
        if head.name == "gh-pages":
            head.checkout()


def make_docs():
    doc_path = os.path.join(r_path, "docs")
    subprocess.call(["make", "html"], cwd=doc_path)


def commit_files():
    author_mail = os.environ["AUTHOR_MAIL"]
    repo = Repo(r_path)
    project_name = "vfxClientToolkit"

    index = repo.index
    diff = repo.index.diff(None)

    if diff:
        for item in diff:
            index.add(item.a_path)

    repo.config_writer().set_value("user", "name", "debug").release()
    repo.config_writer().set_value("user", "email", author_mail).release()

    repo.git.commit("-m", "Rebuilt Docs")


if __name__ == "__main__":
    switch_branch()
    make_docs()
    commit_files()
